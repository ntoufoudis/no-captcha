# No CAPTCHA reCAPTCHA

[![Latest Version on Packagist](https://img.shields.io/packagist/v/ntoufoudis/no-captcha.svg?style=flat-square)](https://packagist.org/packages/ntoufoudis/no-captcha)
[![GitHub Tests Action Status](https://img.shields.io/github/actions/workflow/status/ntoufoudis/no-captcha/run-tests.yml?branch=main&label=tests&style=flat-square)](https://github.com/ntoufoudis/no-captcha/actions?query=workflow%3Arun-tests+branch%3Amain)
[![GitHub Code Style Action Status](https://img.shields.io/github/actions/workflow/status/ntoufoudis/no-captcha/fix-php-code-style-issues.yml?branch=main&label=code%20style&style=flat-square)](https://github.com/ntoufoudis/no-captcha/actions?query=workflow%3A"Fix+PHP+code+style+issues"+branch%3Amain)
[![Total Downloads](https://img.shields.io/packagist/dt/ntoufoudis/no-captcha.svg?style=flat-square)](https://packagist.org/packages/ntoufoudis/no-captcha)

![recaptcha_anchor_2x](https://cloud.githubusercontent.com/assets/1529454/5291635/1c426412-7b88-11e4-8d16-46161a081ece.gif)

## Installation

You can install the package via composer:

```php
composer require ntoufoudis/no-captcha
```

You can publish the config file with:

```php
php artisan vendor:publish --tag="no-captcha-config"
```

This is the contents of the published config file:

```php
return [
];
```

## Configuration

Add `NOCAPTCHA_SECRET` and `NOCAPTCHA_SITEKEY` in **.env** file:
```
NOCAPTCHA_SECRET=secret-key
NOCAPTCHA_SITEKEY=site-key
```

(You can obtain them from [here](https://www.google.com/recaptcha/admin))

## Usage

### Init js source

With default options:
```php
{!! NoCaptcha::renderJs() !!}
```

With [language_support](https://developers.google.com/recaptcha/docs/language) or [onloadCallback](https://developers.google.com/recaptcha/docs/display#explicit_render) options:
```php
{!! NoCaptcha::renderJs('fr', true, 'recaptchaCallback') !!}
```

### Display reCAPTCHA

Default widget:
```php
{!! NoCaptcha::display() !!}
```

With [custom_attributes](https://developers.google.com/recaptcha/docs/display#render_param) (theme, size, callback ...):
```php
{!! NoCaptcha::display(['data-theme' => 'dark']) !!}
```

Invisible reCAPTCHA using a [submit_button](https://developers.google.com/recaptcha/docs/invisible):
```php
{!! NoCaptcha::displaySubmit('my-form-id', 'submit now!', ['data-theme' => 'dark']) !!}

Notice that the id of the form is required in this method to let the autogenerated callback submit the form on a successful captcha verification.

### Validation

Add `'g-recaptcha-response' => 'required|captcha'` to rules array:
```php
$validate = Validator::make(Input::all(), [
    'g-recaptcha-response' => 'required|captcha'
]);
```

### Custom Validation Message
Add the following values to the `custom` array in the `validation` language file:
```php
'custom' => [
    'g-recaptcha-response' => [
        'required' => 'Please verify that you are not a robot.',
        'captcha' => 'Captcha error! Try again later or contact site admin.',
],
],
```

Then check for captcha errors in the `Form`:
```php
@if ($errors->has('g-recaptcha-response'))
    <span class="help-block">
        <strong>{{ $errors->first('g-recaptcha-response') }}</strong>
    </span>
@endif
```

## Testing

When using the [Laravel Testing functionality](https://laravel.com/docs/12/testing), you will need to mock out the response for the captcha form element.

So for any form tests involving the captcha, you can do this by mocking the facade behavior:

```php
// prevent validation error on captcha
NoCaptcha::shouldReceive('verifyResponse')
    ->once()
    ->andReturn(true);

// provide hidden input for your 'required' validation
NoCaptcha::shouldReceive('display')
    ->zeroOrMoreTimes()
    ->andReturn('<input type="hidden" name="g-recaptcha-response" value="1" />');
```

You can then test the remainder of your form as normal.

When using HTTP tests you can add the `g-recaptcha-response` to the request body for the 'required' validation:
```php
// prevent validation error on captcha
NoCaptcha::shouldReceive('verifyResponse')
    ->once()
    ->andReturn(true);

// POST request, with request body including g-recaptcha-response
$response = $this->json('POST', '/register', [
    'g-recaptcha-response' => '1',
    'name' => 'John Doe',
    'email' => 'john@doe.com',
    'password' => 'password',
    'password_confirmation' => 'password',
]);
```

## Changelog

Please see [CHANGELOG](CHANGELOG.md) for more information on what has changed recently.

## Contributing

Please see [CONTRIBUTING](CONTRIBUTING.md) for details.

## Security Vulnerabilities

Please review [our security policy](../../security/policy) on how to report security vulnerabilities.

## Credits

- [Vasileios Ntoufoudis](https://github.com/ntoufoudis)
- [All Contributors](../../contributors)

## License

The MIT License (MIT). Please see [License File](LICENSE.md) for more information.
